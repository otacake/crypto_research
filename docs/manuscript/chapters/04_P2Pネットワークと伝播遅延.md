# 第4章: P2Pネットワークと伝播遅延

第3章で確認したのは、中央裁定者がいない環境では、参加者ごとの観測が一致しないことを前提に設計しなければならない、という点でした。本章は、その観測差がどこで生まれるかを、ネットワークの振る舞いまで下ろして確認します。結論を先に置くと、P2Pでは情報は同時一斉に届かず、複数経路を経て段階的に広がります。そのため、順序共有の設計では「遅延がたまに起きる」ではなく「遅延と到達順差は常に起きうる」を前提に据える必要があります。[一次:S-CH04-001][一次:S-CH03-001]

## 1. 伝播の仕組み

最初に、IT基礎語を本章で使う意味に限定して定義します。サーバーは、要求に応答する側の役割です。クライアントは、要求を送る側の役割です。ノードは、ネットワーク参加者としてデータ検証と中継を行う実体です。プロトコルは、ノード同士がどの順番で何を送受信するかを決める公開規則です。レイテンシ（latency）は、送信から受信までにかかる遅れの時間です。ここではこの5語を混同しないことが、後段の理解の前提になります。

P2P（Peer-to-Peer）は、単一サーバーが全員へ同時配信する構図ではなく、ノードが隣接ノードへ順番に情報を渡して全体へ広げる構図です。たとえば、ある取引を最初に受け取ったノードAは、接続しているノードBとCへ通知し、BとCはさらに接続先へ通知します。この連鎖が同時並行で進むため、ネットワーク全体から見ると到達順は木構造というより、重なり合った多段伝播になります。[一次:S-CH04-001]

ここで日常導入を一つ置きます。学内連絡を、事務局が全学生へ直接送るのではなく、学科ごとの連絡係に渡し、連絡係が研究室へ回す運用を想像すると、P2Pの多段伝播に近い絵になります。最初の配信者から遠い研究室ほど到達が遅れ、途中で担当者が不在ならさらに遅れます。通信プロトコルは人間の連絡網より高速ですが、「段階を経るほど到達時刻が揺れる」という本質は同じです。

素朴案として「回線が十分速ければ実質同時に届く」と考えたくなります。しかし実測研究は、平均遅延が小さい状況でも遅い側の尾部（tail）が残ること、またノード接続関係に偏りがあると同じ取引でも到達順位が入れ替わることを示しています。平均だけが小さいことと、全ノードで順序が一致することは同値ではありません。[一次:S-CH04-001]

破綻例を具体化します。例1は、都市部ノード群と遠隔地ノード群で回線品質が違うケースです。Tx-Aを送った直後にTx-Bが送られると、都市部ではA→Bに見えても、遠隔地ではB→Aに見える場合があります。例2は、同一地域でも再送が発生したケースです。あるノードでは最初の通知を受け取り、別ノードでは再送分で受け取るため、同じ取引群の局所順序がずれます。どちらも悪意を入れなくても起こる差です。[一次:S-CH04-001]

この破綻から引く橋渡しは明確です。問題は「だれが正しい時刻を持っているか」ではありません。問題は「時刻の見え方が異なっても同じ判定へ寄せる仕組みを持てるか」です。したがって、次節では遅延と分断を例外扱いせず、設計要件を作るための常態として扱います。[一次:S-CH03-001][一次:S-CH04-001]

## 2. 遅延と分断

遅延は単なる通信の遅さではなく、順序共有の入力を揺らす要因です。分断はさらに強く、一定時間、ノード群同士が互いの観測を交換できない状態を作ります。現実運用では、メンテナンス、ルータ障害、DDoS耐性設定、地域障害などで部分分断は珍しくありません。したがって「障害時だけの特別ケース」として後回しにすると、実際のシステム条件と設計前提がずれます。[一次:S-CH04-001]

ここで日常導入を二つ置きます。第一は、地下鉄移動中にメッセージが一時的に送れなくなる場面です。自分は送信したつもりでも、相手側の到達時刻は後ろへずれます。第二は、停電で店舗レジ端末がオフラインになる場面です。店舗内では処理が進んでも、外部台帳との同期は再接続後になります。どちらも「処理は進んだが共有は遅れた」という構図です。

破綻例1は遅延偏在です。ノード群XではTx-1が先に入り、ノード群YではTx-2が先に入る。各群の先着規則だけで判定すると、どちらも自群の判断を正当化できるため、全体判定は分裂します。破綻例2は一時分断です。分断区間AとBがそれぞれ独立に履歴候補を伸ばし、再接続後に候補同士が衝突します。ここで公開採択規則がなければ、運用者の主観で履歴が選ばれ、後追い検証ができなくなります。[一次:S-CH04-001]

この二つの破綻の共通点は、悪意の有無に依らないことです。攻撃がなくても、通信条件だけで判定差は発生します。したがって脅威モデルを「攻撃者がいるか」にだけ寄せると、平常時に起きる観測差を見落とします。順序共有の設計では、まず善意環境での不一致を吸収できることを確認し、そのうえで攻撃条件を重ねる順序が必要です。[一次:S-CH03-001][一次:S-CH04-001]

ここで断定を避ける領域も明示します。遅延の分布値、分断頻度、再接続後の収束時間は、ノード数・接続形状・実装更新・時間帯で変わるため、単一値で一般化できません。本章では値を固定せず、「遅延と分断が設計入力になる」という構造主張に留めます。数値比較が必要な論点は要検証として扱います。（要検証）

橋渡しとして、要件を1文で固定します。遅延と分断を消す設計は現実的ではないため、必要なのは「遅延と分断があっても、候補比較と棄却理由が最終的に一致へ寄る規則」です。次節では、この要件を観測順差の形で具体化します。[一次:S-CH03-001][一次:S-CH04-001]

## 3. 観測順の差

観測順の差とは、同じ取引集合を見ても、ノードによって「どれが先に到達したか」が異なる状態です。ここで重要なのは、差が出たからといって即座に不正と決めつけないことです。差の多くは通信と処理順の揺らぎから自然に生まれます。[一次:S-CH04-001]

この差は、入力差→処理差→判定差→履歴差という連鎖で拡大します。入力差は到達順の違いです。処理差はメモリプールへの格納順や検証キュー順の違いです。判定差は同一入力消費の競合時にどちらを先に有効とみなしたかの違いです。履歴差は最終的にどの候補が主履歴に入ったかの違いです。連鎖のどこかで共通規則を適用しないと、後段で差分説明が不可能になります。[一次:S-CH03-001][一次:S-CH04-001]

具体例Aとして、同じUTXOを参照するTx-AとTx-Bを考えます。ノードN1はAを先に受け取り、N2はBを先に受け取る。局所先着だけで有効判定すると、N1とN2は互いに逆の取引を保持します。ここで「どちらの観測が真か」を争っても解決しません。必要なのは、後段で同じ採択規則を適用したときに同じ結果へ寄ることです。[一次:S-CH05-001][一次:S-CH04-001]

具体例Bとして、同時刻近傍に見つかった二つのブロック候補を考えます。あるノード群は枝Xを、別群は枝Yを先に受け取ります。先着固定ルールなら分岐が持続しますが、公開収束規則を持てば時間とともに片側へ収束できます。この違いは、観測順差を「異常」とみなすか「設計入力」とみなすかの違いです。[一次:S-CH08-001][一次:S-CH04-001]

破綻から要件への橋渡しを明示します。観測順差を扱う設計では、第一に候補同士を同じ尺度で比較できること、第二に棄却理由を他ノードへ説明できること、第三に時間経過で採択差が縮むことが必要です。逆にこの三点が欠けると、ノード追加や障害復旧のたびに分岐説明コストが増大します。[一次:S-CH03-001]

次節では、この要件を章として固定し、後続章でどの技術部品がどの要件を担うかを接続します。ここで要件を曖昧にすると、後続章が単なる用語列挙になり、なぜその仕組みが必要かを読者が再構成できなくなります。[一次:S-INTRO-001]

## 4. 設計要求

本章で得た設計要求を四点に整理します。要求1は比較可能性です。競合候補を同じ粒度で比較できること。要求2は説明可能性です。採択・棄却の理由を公開手順で再現できること。要求3は収束性です。一時的不一致があっても時間経過で履歴が一本化へ向かうこと。要求4は追試可能性です。第三者が後から同じ判定を再現できることです。[一次:S-CH03-001][一次:S-CH04-001]

ここで補足します。時刻情報を完全に捨てる必要はありません。必要なのは、時刻を最終判定の唯一根拠にしないことです。時刻は観測補助として有用ですが、ネットワーク全体で同一観測が保証されないため、時刻単独での採択は分岐を固定化しやすくなります。[一次:S-CH03-001]

この設計要求を後続章へ写像すると、次の対応になります。比較可能性は第5章のUTXOと入力参照規則が担います。説明可能性と追試可能性は第6章のブロック構造とハッシュ連結が担います。収束性は第7章のPoWコスト設計と第8章の収束規則が担います。第9章と第10章は、これら規則が維持される経済条件と運用境界を担います。[一次:S-CH05-001][一次:S-CH06-001][一次:S-CH07-001][一次:S-CH08-001][一次:S-CH09-001][一次:S-CH10-001]

最後に、本章の結論を再固定します。P2Pでは情報は同時到達しません。遅延と分断は常態です。だから順序共有は、遅延をなくす設計ではなく、遅延があっても判定が収束する規則の設計でなければなりません。この前提を先に持つことが、ブロックチェーンを「発行技術」ではなく「順序共有技術」として理解する入口になります。[一次:S-CH04-001][一次:S-CH03-001][一次:S-INTRO-001]

### 章内補足: 伝播遅延を設計入力として読む実務例

ここで、観測順差を設計入力として扱う意味をもう一段具体化します。たとえば決済アプリ運用者が「受付済み」という表示を利用者へ返すとき、内部ではどの状態を根拠に表示しているかを定義しなければなりません。メモリプール到達時点で受付表示を出すのか、一定の収束条件を満たした時点で表示するのかで、再編成時の説明責任が変わります。表示定義が曖昧なままでは、同じイベントでも担当者ごとに案内内容がぶれます。（要検証）

この問題は、サーバー/クライアント型の思考をそのままP2Pへ持ち込むと起こりやすくなります。単一サーバーなら、サーバー受理時刻を基準に一意な案内が可能です。しかしP2Pでは、どのノードを「基準サーバー」と見なすか自体が制度設計です。したがって「いつ受理したか」より「どの規則で受理と呼ぶか」を先に公開しなければ、同じネットワークでも受理概念が複数化します。[一次:S-CH04-001]

運用現場で使える最小ルールとして、三段の状態表示を推奨できます。第一段は「受信済み（局所観測）」、第二段は「候補採択中（分岐可能性あり）」、第三段は「運用上確定（閾値到達）」です。これを最初に定義しておけば、遅延・分断・再編成が起きても、状態遷移を同じ言葉で説明できます。（要検証）

さらに、監視項目を先に置くことも重要です。最低限、ノード間の到達時刻差、候補枝の同時存在時間、再編成発生回数を継続観測し、悪化傾向を検出する必要があります。観測しない設計は、発生後の説明を主観へ寄せます。観測している設計は、発生前に閾値超過を検知して設定変更や案内強化へつなげられます。（要検証）

最後に、本章の設計要求をチェックリストとして再掲します。1) 候補比較の粒度が固定されているか。2) 採択/棄却理由を他ノードが再現できるか。3) 遅延・分断時の状態表示語彙が定義されているか。4) 収束の観測指標を持っているか。5) 後続章のデータモデル・履歴固定・誘因設計へ接続できるか。五つを満たせば、伝播遅延を「事故」ではなく「設計前提」として扱える状態に近づきます。[一次:S-CH03-001][一次:S-CH04-001]

### 章内補足2: 用語の橋渡し確認

本章で出したIT基礎語を最後に再確認します。ノードは「参加者の実体」、プロトコルは「公開規則」、レイテンシは「到達遅れ」です。この三つを分けて理解すると、遅延問題を個人責任ではなく構造問題として扱えます。構造問題として扱えると、対策は精神論ではなく規則設計へ移ります。

実務上の誤解として多いのは、遅延を「通信品質の悪い個別ノードの問題」として局所化してしまうことです。局所改善は有効ですが、順序共有の観点では全体で観測差が残る限り問題は消えません。したがって個別改善と同時に、観測差を吸収する採択規則を維持する必要があります。[一次:S-CH04-001]

本章を終える時点で読者が言えるべき一文は次です。「P2Pでは到達順差は常態であり、設計課題は遅延排除ではなく遅延下収束である」。この一文が定着していれば、第5章以降の技術要素を要件対応として読む準備が整っています。[一次:S-CH03-001][一次:S-CH04-001]

### 章内補足3: まとめの一文

第4章の要点は、通信遅延を「例外」ではなく「前提」として扱うことです。前提化できれば、設計者の関心は時刻の正しさ争いから、規則の再現性と収束性へ移ります。この視点転換が、後続章を要件対応として読むための土台です。[一次:S-CH04-001]

最後に、本章の終端を一段落で固定します。伝播遅延を扱う設計とは、平均値の良否だけで安心することではなく、不一致が起きる条件を前提として規則を組み立てることです。要件先行で読む限り、後続章のデータモデル、履歴固定、誘因設計は「なぜ必要か」で接続できます。本章の最終到達点は、遅延を排除対象ではなく収束設計の入力として扱う視点を実務判断まで落とし込むことです。[一次:S-CH04-001]

補足として、遅延条件を先に固定することが後続章の誤読防止に最も効きます。[一次:S-CH04-001]

補足として、観測差を前提化した設計では、表示語彙の定義も規則の一部として扱う必要があります。受信済み、候補採択中、運用上確定の語を分けておけば、同じイベントでも利用者に対して一貫した説明が可能です。語彙定義がない運用では、内部状態が同じでも窓口ごとに案内が変わり、結果として順序管理そのものへの信頼が下がります。第4章の設計要求は通信規則だけで閉じません。観測差を説明可能にする語彙管理まで含めて初めて機能します。[一次:S-CH04-001]

追加で、伝播遅延の説明では「平均遅延」と「末尾遅延」を分けて扱うことを推奨します。平均が改善しても末尾が悪化すれば、競合時の逆転確率は下がらない場合があります。第4章でこの区別を意識すると、通信改善と収束改善を同一視しにくくなります。設計評価では、平均性能の改善と収束安定性の改善を別指標で確認してください。（要検証）

# 第5章: 取引データモデル（UTXO）

第4章で、P2P伝播には遅延と到達順差が内在し、局所観測だけでは全体順序を固定できないことを確認しました。本章の問いは、そのような環境で重複消費をどう機械的に拒否するかです。ここで中心になるのが UTXO（Unspent Transaction Output）モデルです。結論を先に言うと、UTXOは「価値片の未使用/使用済み」を明示することで、競合取引の判定単位を固定し、順序収束規則が働くための土台を作ります。[一次:S-CH05-001][一次:S-CH04-001]

## 1. モデル選択

最初に日常導入を置きます。紙の商品券を一枚だけ持っているとき、その券を一度レジで使えば同じ券番号を再利用できません。デジタル取引でも同じで、「どの価値片がまだ使えるか」を共有できなければ、同じ価値を二度使う問題が発生します。UTXOはこの「使える価値片」を集合として管理するモデルです。[一次:S-CH05-001]

ここで、残高モデルとの違いを簡潔に整理します。残高モデルは口座の合計値を更新対象にします。UTXOモデルは、個々の出力片を更新対象にします。残高モデルが悪いという話ではなく、順序差がある環境で競合判定を説明しやすい粒度がどちらか、という設計選択の話です。[一次:S-CH05-001]

素朴案として「最終残高が合っていれば途中は気にしなくてよい」と考えると、競合時の説明責任が抜けます。たとえば同じ100単位を使うTx-AとTx-Bが同時近傍で届いたとき、どちらを先に反映したかで途中残高は割れます。途中状態を説明できない設計は、後追い監査で「なぜこの取引を棄却したか」を再現できません。[一次:S-CH05-001][一次:S-CH03-001]

UTXOモデルの利点は、判定対象が明確なことです。各取引入力は、特定の過去出力を参照して消費します。参照先が未使用か、条件を満たしているかを確認し、満たさなければ棄却します。この手順は「口座全体の状態推定」ではなく「参照先の状態判定」であるため、競合時の棄却理由を具体的に記述できます。[一次:S-CH05-001]

具体例Aを置きます。UTXO#123を入力に使うTx-Aが先着した場合、Tx-A受理後はUTXO#123が消費済みになります。後から同じUTXO#123を参照するTx-Bが来たら、棄却理由は「参照先が既消費」で固定できます。具体例Bとして、Tx-Aの署名条件不備で棄却した後にTx-Bが正しい条件で来た場合、UTXO#123は未使用のままなのでTx-Bは有効候補になります。どちらも判定理由が局所的に明確です。[一次:S-CH05-001]

この破綻と具体例からの橋渡しは明確です。第4章で必要だった「比較可能性」を実装するには、候補取引を同じ粒度で比較できる表現が必要です。UTXOはその粒度を「特定出力の消費可否」に固定します。次節では、この粒度が入出力構造としてどう動くかを具体化します。[一次:S-CH04-001][一次:S-CH05-001]

## 2. 入出力構造

UTXO取引は、入力（どの出力を使うか）と出力（次にどう使えるか）で構成されます。ノード検証は、入力参照の存在確認、未使用確認、条件確認、そして状態更新の順に進みます。この順序が曖昧だと、同じ取引でもノードごとに結論が割れます。[一次:S-CH05-001]

ここでIT基礎語の補足を置きます。プロトコル上の「有効/無効」は、誰かの好みではなく、公開規則に照らした機械的判定です。ノード実装が異なっても、規則解釈が一致すれば同じ入力に同じ出力が出ることが期待されます。したがって、入出力構造の定義は実装最適化より先に固定する必要があります。

破綻例1は、同一UTXOを使う競合Txが同時到達した場面で、実装Aは到達順優先、実装Bは手数料順優先で判定するケースです。規則が明文化されていないと、両実装はそれぞれ一貫していても相互整合を失います。破綻例2は、検証前に状態更新を先行し、失敗時ロールバックを実装依存で処理するケースです。ロールバック漏れがあると、一時的に「消費済みのはずなのに未使用に戻る」矛盾が起きます。（要検証）

この破綻から必要条件を3つ抽出できます。条件1は判定順序の公開です。条件2は状態遷移の原子性、つまり成功時だけ更新し失敗時は無更新を保証することです。条件3は棄却理由コードの標準化です。棄却理由コードが揃えば、ノード間で「なぜ弾いたか」を比較できます。[一次:S-CH05-001]

日常導入で言い換えると、入出力構造は「誰が何番の整理券をいつ使ったか」を管理する台帳です。整理券番号が明確なら、二重利用は番号衝突として即座に検出できます。番号が曖昧なら、窓口ごとに判断がぶれ、後で整合が取れません。

橋渡しとして次節へ進みます。入出力構造だけでは「どの価値片か」は分かっても「その価値片を使う権限があるか」は分かりません。ここを埋めるのが署名検証です。つまり本章の中でも、データ構造と権限検証は分業です。[一次:S-CH05-001]

## 3. 署名検証

署名検証の役割は、入力が参照する出力を、正当な条件で消費しているかを確認することです。UTXOが「何を使うか」を定義するなら、署名は「誰が使えるか」を定義します。どちらか一方だけでは有効判定は成立しません。[一次:S-CH05-001]

ここで素朴案を退けます。「参照先が未使用なら受理してよい」という考えは、権限概念を落とします。逆に「署名が正しければ受理してよい」という考えは、状態概念を落とします。順序共有の現場で必要なのは、状態と権限の同時充足です。この二層を分けて理解しないと、障害分析で原因を取り違えます。[一次:S-CH05-001]

具体例Aとして、未使用UTXOを権限外署名で消費しようとする取引を考えます。状態条件は満たしても権限条件で棄却されます。具体例Bとして、権限ある署名だが参照先が既消費の取引を考えます。権限条件は満たしても状態条件で棄却されます。棄却理由が異なるため、監査ログでも区別が必要です。[一次:S-CH05-001]

ここで、要検証の範囲を分離しておきます。スクリプト機能拡張や署名方式の世代差は実装差分が大きいため、本書では一般原理（状態と権限の同時検証）に焦点を置き、個別命令セットの完全網羅は対象外とします。個別実装差分を断定する主張は、都度一次資料で確認が必要です。（要検証）

この節の橋渡しを明示します。署名検証まで入れることで、受理/棄却は主観ではなく規則へ落ちます。しかし、競合候補が複数ある場合は「どれを履歴へ採るか」がまだ残ります。次節で、UTXOが順序規則とどう接続するかを固定します。[一次:S-CH03-001][一次:S-CH08-001]

## 4. 順序との関係

UTXOは、順序そのものを決める装置ではありません。UTXOが担うのは、競合の同定です。どの取引が同じ出力を取り合っているかを機械的に示すことで、後段の収束規則が適用できる入力を整えます。言い換えると、UTXOは「争点の定義」、収束規則は「採択の決定」です。[一次:S-CH05-001][一次:S-CH08-001]

この分業を誤ると二つの誤解が出ます。第一の誤解は「UTXOがあるから自動で全体順序が一致する」です。実際には採択規則が必要です。第二の誤解は「採択規則さえあればデータモデルは何でもよい」です。実際には競合同定が不明確だと採択規則が働きません。両者は代替関係ではなく補完関係です。

具体例として、同一UTXO競合Tx-A/Bを含む二つのブロック候補を考えます。UTXO規則で「AとBは同時採用不可」が確定し、収束規則で「どちらの枝を採るか」が決まります。もしUTXO規則が曖昧なら、枝比較以前にブロック妥当性が割れます。逆に収束規則が曖昧なら、妥当な複数枝が並立して一本化が遅れます。[一次:S-CH05-001][一次:S-CH08-001]

ここで章全体の要件対応をまとめます。比較可能性は入出力構造が担い、説明可能性は棄却理由の標準化が担い、収束性は後続章の合意規則が担います。第5章の役割は、このうち前二者の基礎を作ることです。したがって本章を読むときは「難しい暗号仕様」より「判定単位の固定」に着目するのが適切です。[一次:S-CH05-001][一次:S-CH03-001]

第6章への接続を明示します。次章では、ここで有効候補となった取引集合をブロックとして固定し、ハッシュ連結とMerkle構造で第三者追試可能な履歴へ変換します。第5章の判定土台がなければ、第6章の履歴固定は説明可能性を持てません。[一次:S-CH06-001]

最後に結論を固定します。UTXOモデルの価値は、残高表示の見た目ではなく、未使用出力の消費可否を機械的に判定できることにあります。順序共有の文脈では、これが競合同定の基盤となり、収束規則の入力を安定化させます。[一次:S-CH05-001][一次:S-INTRO-001]

### 章内補足: UTXO判定を運用手順へ落とすときの注意

ここで、UTXOを理解したつもりでも運用で崩れやすい点を補足します。典型的には、開発側が「有効/無効」の二値だけを返し、運用側が棄却理由を管理しないケースです。二値だけだと、同じ無効でも「署名不備」なのか「既消費参照」なのかが区別できません。区別できないと、利用者へ誤った再送案内を出し、結果として混雑と再試行失敗を増やします。（要検証）

UTXOモデルを実務で活かすには、棄却理由を少なくとも三層へ分ける設計が有効です。第一層は参照不整合（参照先不存在・既消費）です。第二層は権限不整合（署名条件不一致）です。第三層は構文・サイズ等の形式不整合です。三層を分離すると、原因分析と再試行方針を局所化できます。ここでの目的はエラー分類を細かくすること自体ではなく、再現可能な運用判断を作ることです。[一次:S-CH05-001]

また、同時到達時の判定順を固定しておく必要があります。たとえば同一UTXO競合Txが複数来た場合に、先着優先で保持するのか、手数料等の付加規則を使うのか、保留キューへ置くのかを文書化しなければ、ノード更新時に挙動が変わります。挙動差は「バグ」に見えても、実際は規則未固定が原因ということが多く、監査で最も時間を失う箇所になります。（要検証）

さらに、UTXOセットの保守は可用性課題でもあります。状態サイズが増え続けると、再起動復元や新規ノード同期に時間がかかり、結果として観測差の窓が広がります。したがって第5章の論点は整合性だけではなく、整合性を維持しながら運用可能な状態管理を作ることです。整合性と可用性を分離して扱うのではなく、同じ設計会話で扱う必要があります。（要検証）

読者がここで確認すべき実務チェックを置きます。1) 競合取引の同定単位が明確か。2) 署名検証と状態検証の失敗理由が分離されているか。3) ノード実装差があっても判定順序を再現できるか。4) 再試行時に何を変えればよいか利用者へ説明できるか。5) 第6章のブロック化に渡す前提が固定されているか。これらが揃ってはじめて、UTXOは理論用語ではなく、順序共有の実運用部品になります。[一次:S-CH05-001][一次:S-CH06-001]

最後に、UTXOに関する誤配点を再確認します。UTXOは「万能な順序決定器」ではありません。UTXOが定義するのは競合同定であり、採択収束は後続規則が担います。逆に言えば、UTXOが曖昧だと後続規則の性能議論は空回りします。本章の価値は、この依存関係を明確にし、どこで判定が決まり、どこで履歴が決まるかを分解して理解できる点にあります。[一次:S-CH05-001][一次:S-CH08-001]

### 章内補足2: 競合同定と採択決定を混ぜない

UTXOを読むときの実務上の要点は、競合同定と採択決定を分けることです。競合同定は「同じ出力を取り合っているか」を判断する層で、採択決定は「どの候補を履歴へ入れるか」を判断する層です。二層を混ぜると、障害時に「判定が誤ったのか」「採択規則が異なったのか」を切り分けられません。[一次:S-CH05-001]

この切り分けは、問い合わせ対応でも重要です。利用者へ「なぜ失敗したか」を説明するとき、参照不整合なのか権限不整合なのか、あるいは競合先が先に採択されたのかで案内内容が変わります。説明を正確に分けられる運用は、再送トラブルと誤解を減らします。

第5章の最終確認として、次の三問に答えられるかを点検してください。1) UTXOで何を状態として持つか。2) 有効判定に必要な条件は何か。3) 収束規則へ渡す入力は何か。三問へ明確に答えられるなら、UTXOは単なる語彙でなく、順序共有の判定基盤として理解できています。[一次:S-CH05-001][一次:S-CH08-001]

### 章内補足3: UTXOの読了チェック

読了時点で確認すべきことは、UTXOを「残高の代用品」としてではなく「競合同定の単位」として説明できるかです。ここが言えれば、第8章の収束規則で何が争点になるかを見失いません。言えない場合は、入力参照と棄却理由の関係へ戻るのが最短です。[一次:S-CH05-001][一次:S-CH08-001]

また、実装差分を評価するときは、仕様準拠か性能最適化かを分けて読む必要があります。仕様準拠差分は整合性へ直接影響し、性能差分は主にレイテンシへ影響します。両者を混同すると、優先して直すべき論点を誤ります。（要検証）

補足の締めとして、UTXOは「どの価値片を誰が使えるか」を再現可能に定義する仕組みだと覚えてください。この再現可能性があるからこそ、収束規則で候補を比較したときに同じ争点で議論できます。[一次:S-CH05-001]

追加補足として、UTXOの運用品質は「失敗時に何を再試行すべきか」を明確に示せるかで測れます。参照不整合なら競合解消待ち、権限不整合なら署名条件修正、形式不整合なら再構築というように、原因と対処を一対で提示できる状態が理想です。原因を区別しない案内は再送を増やし、ネットワーク負荷と利用者混乱を同時に高めます。したがって判定基盤としてのUTXOは、整合性だけでなく対話可能性の基盤でもあります。[一次:S-CH05-001]

最後に短く固定します。UTXOは、整合性検証だけでなく、利用者への再試行案内を正しく分岐させるための基盤でもあります。参照不整合と権限不整合を分けて説明できる運用は、混雑時ほど効果を発揮します。この点を押さえると、第5章の役割は単なるデータ構造説明を超えて、順序共有の対話可能性を支える層だと理解できます。[一次:S-CH05-001]

補足終端を統合して固定します。UTXOの価値は、競合を同じ形式で切り分け、再現可能な棄却理由を残せる点にあります。これにより、失敗時の案内を「参照不整合」「権限不整合」「形式不整合」で分岐でき、再試行の方向を具体化できます。したがって第5章の結論は、UTXOを残高の見た目ではなく、競合同定と説明可能性を支える判定基盤として理解することです。[一次:S-CH05-001]

この再現可能性が、UTXOを順序共有の実務基盤にします。[一次:S-CH05-001]

追加で、UTXOを運用へ接続する観点を一つ置きます。競合検知後の再送案内は、利用者体験の品質を大きく左右します。参照不整合なら競合解消待ち、権限不整合なら署名条件修正、形式不整合なら再構築という分岐を明示できる運用は、同じ失敗を繰り返しにくくなります。UTXOは技術的整合性の道具であると同時に、失敗時の対話品質を保つ道具でもあります。この視点を持つと、第5章の価値はデータ構造説明を超えて、実運用の再現可能性へ接続します。[一次:S-CH05-001]

# 第8章: 合意の収束とフォーク

第7章では、履歴改ざんに計算コストを課す地盤としてPoWと難易度調整を確認しました。本章の問いは、観測差がある環境で一時的に複数履歴が生まれたとき、どのように一本化へ向かうかです。中心になるのは、フォーク発生の理解、収束規則、再編成、実用確定性です。結論を先に置くと、フォークは失敗の証拠ではなく、分散環境で収束するために避けられない中間状態です。[一次:S-CH08-001][一次:S-CH04-001]

## 1. フォークの発生

最初に日常導入を置きます。共同編集している議事録で、同時に二人が別版を保存すると短時間だけ版が分かれます。統合規則があれば、最終的に一本へ戻せます。フォークも同じで、同時近傍に複数ブロック候補が見つかると、ノード群ごとに先着枝が一時的に分かれます。[一次:S-CH08-001]

ここで重要なのは、フォーク発生を即「不正」と結びつけないことです。善意ノードしかいなくても、伝播遅延と観測順差で分岐は起きます。したがって、フォークゼロを目標にするより「フォークが起きても収束できる規則」を持つほうが現実的で強い設計です。[一次:S-CH08-001][一次:S-CH04-001]

素朴案として「最初に見えた枝を固定する」を採ると、局所観測依存が強くなります。ノードAが枝Xを先着、ノードBが枝Yを先着と見た時点で、固定先が分かれます。局所先着は簡単ですが、全体収束を保証しません。分散環境で必要なのは簡単さだけではなく、観測差を吸収できることです。[一次:S-CH08-001]

破綻例1は、先着固定ルールで枝が持続分裂するケースです。破綻例2は、分岐時の採択を運用者手動判断に委ね、拠点ごとに結論が変わるケースです。後者は一時的には収束して見えても、後追い監査で再現不能になります。公開規則を欠いた収束は、将来の説明コストを増やすだけです。（要検証）

この破綻から橋渡しされる要件は三つです。第一に分岐発生の許容、第二に分岐後採択の公開規則、第三に採択変更時の機械的再現性です。分岐を否認すると運用が隠蔽へ寄り、採択規則を曖昧にすると整合が崩れます。次節は、この三要件を収束規則として固定します。[一次:S-CH08-001]

## 2. 収束規則

収束規則は、複数枝が存在する局面で「どの枝を主履歴候補として追うか」を決める規則です。Bitcoinの説明では、作業量の大きい側へ追随する考え方が採られます。名称より大切なのは、採択基準が公開され、ノード実装をまたいで再現可能であることです。[一次:S-CH08-001]

ここで素朴案として「多数派が選んだ枝を正とすればよい」と言うだけでは不足です。多数の定義は観測範囲と時点に依存し、遅延中は別多数が同時に成立します。したがって、収束規則は感覚的な多数論ではなく、計算可能な採択手順として記述する必要があります。（要検証）

具体例Aとして、枝Xと枝Yが同時に存在する局面を考えます。ノードN1はX先着、N2はY先着ですが、共通の採択基準を適用すると時間経過で同じ枝を選ぶ可能性が高まります。具体例Bとして、採択基準は同じでも再検証範囲が実装差で異なる場合、採択タイミングがずれ、再編成通知が不統一になります。採択規則の統一だけでなく、適用手順の統一が必要です。[一次:S-CH08-001]

破綻例として、採択規則の文言は同じでも、枝切り替え時の状態更新順が異なる実装を考えます。ある実装は先に旧枝の取引を戻し、次に新枝取引を適用します。別実装は逆順で行います。中間状態の扱いが異なると、同時照会で一時不一致が観測されます。したがって、収束規則は採択基準だけでなく状態遷移手順まで含めて定義する必要があります。（要検証）

橋渡しとして次節へ進みます。採択変更が発生するなら、運用上は再編成を正常な更新手続きとして設計しなければなりません。再編成を例外障害扱いにすると、利用者説明と内部状態が乖離します。[一次:S-CH08-001]

## 3. 再編成

再編成（reorg）は、暫定的に追っていた枝を外し、収束規則で選ばれた別枝へ切り替える処理です。ここでのポイントは、再編成を異常として隠すのではなく、収束過程の標準動作として定義することです。定義されていれば、発生時の手順・通知・表示を一貫化できます。[一次:S-CH08-001][要検証:RB-003]

日常導入として、会議の暫定議事録が確定版で差し替わる場面を考えます。暫定版を「誤り」と断定するより、確定手順に従った更新と説明するほうが参加者の理解は安定します。ブロックチェーンでも同様に、再編成は「取り消しと再適用の手続き」であり、隠す対象ではありません。

素朴案として「再編成は稀なのでUIで無視してよい」とすると、利用者は後から状態が変わった理由を理解できません。内部では切り替えが起きているのに、外部表示が固定されると、障害報告時に信頼を失います。再編成を説明できる設計は、正確性だけでなく運用透明性の要件でもあります。（要検証）

破綻例1は、再編成時のロールバック手順がなく、旧枝取引が二重反映されるケースです。破綻例2は、通知規則が曖昧で、ある利用者には確定、別利用者には未確定として表示されるケースです。前者は台帳整合を、後者は利用者判断を損ないます。どちらも再編成を標準業務として定義していれば防げる領域です。（要検証）

橋渡しとして要件を固定します。再編成対応には、第一に暫定/確定の状態分離、第二に巻き戻しと再適用の機械手順、第三に対外説明文言の標準化が必要です。技術手順と説明手順を別々に設計すると、障害時に片方だけ更新され、矛盾が残ります。[一次:S-CH08-001][要検証:RB-003]

## 4. 実用確定性

分散環境の確定性は、絶対不変の宣言ではなく、再編成確率が十分低くなった点を運用上の確定とみなす考え方です。ここで重要なのは、確率を隠さないことです。曖昧な「ほぼ確定」ではなく、どの閾値を採るかを公開することで、利用者と運用者の期待差を減らせます。[一次:S-CH08-001][要検証:RB-003]

この節で避けるべき誤解は二つです。第一に、確率的確定を「不正確」と同一視すること。実際には不確実性を管理するための明示的手続きです。第二に、閾値を固定値で万能化すること。取引規模、許容リスク、業務要件で適切閾値は変わります。閾値は政策判断であり、技術仕様の一行で完結しません。（要検証）

具体例Aとして、小額決済では短い待機で実務上受容できる場合があります。具体例Bとして、高額決済では長い待機と追加確認が必要になる場合があります。同じチェーンでも業務文脈で運用閾値が変わるため、「何確認で絶対安全」と断定する主張は注意が必要です。（要検証）

ここで設計要求をまとめます。要求1は確定閾値の公開、要求2は未確定状態の明確表示、要求3は再編成時の通知と再試行手順、要求4は監査ログでの時点記録です。これらが揃うと、利用者は状態変化を予測でき、運用者は後追い説明を再現できます。[一次:S-CH08-001]

第9章への接続を明示します。第8章は「どう収束するか」の章でした。第9章は「なぜ参加者が収束規則へ従い続けるか」を扱います。収束規則が存在しても、行動誘因が弱ければ維持されません。次章で報酬と利得比較を重ねます。[一次:S-CH09-001]

最後に結論を固定します。フォークは発生し得ます。再編成も起き得ます。重要なのはこれらを例外として隠すことではなく、公開された収束規則と確率的確定運用で一貫して扱うことです。これが中央裁定者なしで順序共有を維持する実務の核心です。[一次:S-CH08-001][一次:S-INTRO-001]

### 章内補足: フォーク運用を「例外対応」ではなく「標準業務」にする

フォークと再編成を実務で扱う際、最も効果が大きいのは運用文言を統一することです。たとえば、同じ状態を担当者Aは「完了」と呼び、担当者Bは「暫定」と呼ぶと、利用者への説明が矛盾します。したがって技術処理の前に、状態語彙を固定し、どのイベントでどの状態へ遷移するかを文書化する必要があります。（要検証）

状態語彙の最小セットとして、`受信` `候補` `暫定採択` `運用上確定` の四段を用意すると、再編成時の説明が整理しやすくなります。`受信` はノード局所で観測した段階、`候補` は有効性検証中、`暫定採択` は枝選択中、`運用上確定` は閾値到達後です。四段へ分けると、どこまでを利用者行動可能状態とみなすかを業務ごとに決めやすくなります。（要検証）

再編成時の実務処理は、技術手順と顧客手順を同時に設計しなければなりません。技術側では、旧枝取引の巻き戻し、新枝取引の再適用、状態キャッシュ更新を順序化します。顧客側では、表示更新、通知、再試行案内を順序化します。どちらか片方だけ整備すると、内部整合は取れても外部信頼が崩れます。[一次:S-CH08-001]

破綻例Aは、再編成時の内部処理は成功したが通知を出さなかったため、利用者が古い状態で意思決定して損失を被るケースです。破綻例Bは、通知は出したが内部状態更新が遅れ、問い合わせへ一貫回答できないケースです。どちらも「再編成は稀」という思い込みで標準手順化していないと起きます。（要検証）

この破綻から導く要件は四つです。要件1は再編成検知の自動化、要件2は巻き戻し手順の機械化、要件3は通知テンプレートの標準化、要件4は再編成後監査ログの保持です。要件4まで持つと、後追い分析で「何が起きたか」を再構成でき、次回改善へ接続できます。（要検証）

さらに、実用確定性の閾値設定には業務文脈が必要です。小額・高頻度取引では待機時間を短くする運用が合理的な場合があります。高額・低頻度取引では待機時間を長くし、追加確認を組み合わせる運用が合理的な場合があります。同じプロトコルでも、業務目的が異なれば閾値設定は変わります。これを「恣意」と呼ぶのではなく、条件付き意思決定として明示することが重要です。（要検証:RB-003）

読者向けの運用チェックを置きます。1) フォーク発生を障害ではなく前提として扱っているか。2) 収束規則の採択基準と適用手順が分かれていないか。3) 再編成時の状態遷移語彙が統一されているか。4) 閾値設定の根拠と対象業務が明示されているか。5) 再編成後の説明と監査が同じログに基づいているか。五つを満たせば、フォークは混乱源ではなく、管理可能な収束過程として扱えます。[一次:S-CH08-001]

最後に補足の結論を固定します。フォーク運用の成熟度は、分岐を減らすことだけで測れません。分岐が起きたときに、同じ語彙、同じ手順、同じ証拠で処理・説明・監査を回せるかで測るべきです。この視点を持つと、第9章の誘因設計と第10章の限界管理へ自然につながります。[一次:S-CH08-001][一次:S-CH09-001][一次:S-CH10-001]

### 章内補足2: 確定表示と内部状態を一致させる

再編成運用で最も重要なのは、内部状態モデルと外部表示モデルを一致させることです。内部では暫定と確定を分けていても、外部表示が単一ラベルだと、状態変化の説明ができません。逆に表示だけ細かくても、内部状態が追随しなければ問い合わせ対応が破綻します。（要検証）

したがって、表示設計はUI課題ではなく合意運用課題です。どのイベントで表示が変わるか、変わったとき何を通知するか、通知後にどの行動を推奨するかを同時に決める必要があります。ここを後回しにすると、フォークは技術的には解消していても、利用者体験としては「突然変わる不安定な仕組み」に見えます。

本章の読後チェックを置きます。1) フォークを異常ではなく中間状態として説明できるか。2) 収束規則の採択基準と適用手順を区別して説明できるか。3) 再編成時の通知・再試行方針を提示できるか。4) 確定閾値の業務依存性を説明できるか。四つに答えられるなら、合意収束を実務目線で理解できています。[一次:S-CH08-001]

補足の結論を一文で固定します。「合意収束の品質は、分岐が起きないことではなく、分岐が起きたときに同じ規則と同じ説明で戻せること」。この一文が第9章の誘因設計へ接続する橋になります。[一次:S-CH08-001][一次:S-CH09-001]

### 章内補足3: 収束品質を測る観測項目

収束品質を継続的に測るには、少なくとも三つの観測項目が必要です。第一は分岐の同時存在時間、第二は再編成の深さ、第三は再編成後の復旧時間です。三項目を時系列で見れば、「たまたま起きた揺れ」か「構造的な悪化」かを判定しやすくなります。（要検証）

また、利用者向けには確定概念の段階表示を維持することが重要です。内部で収束していても、利用者が段階を理解できなければ運用信頼は上がりません。収束規則の正しさと説明の分かりやすさを同じ重要度で扱うことが、実務上の再発防止に直結します。[一次:S-CH08-001]

本章の最終確認として、「フォークは異常ではなく中間状態」という説明を、具体例付きで語れるかを点検してください。語れれば、確率的確定性の理解が定着しています。[一次:S-CH08-001]

補足の最終行として、フォーク管理の品質は「分岐ゼロ」ではなく「分岐発生時の説明一貫性」で測るべきだと強調します。これができれば、収束規則は運用上の信頼へつながります。[一次:S-CH08-001]

追補として、確定表示を扱う部署間で定義差がないかを定期点検してください。定義差は平常時に見えにくく、再編成時に一気に表面化します。定期点検で用語と状態遷移を揃えることで、分岐発生時の説明一貫性を維持できます。これは技術運用だけでなく、利用者信頼維持の要件でもあります。[一次:S-CH08-001]

締めとして、収束規則の実効性は「技術的に正しいか」だけでなく「利用者へ同じ言葉で説明できるか」で測るべきです。再編成が起きた際に、内部状態と外部案内が同時に更新される運用は、分岐そのものより大きな混乱を防ぎます。したがって第8章の学習目標は、規則理解と説明一貫性を同時に満たすことです。[一次:S-CH08-001]

最終補足です。収束規則の信頼性は、再編成時でも同じ状態語彙で案内できるかで決まります。技術と説明の一致を維持することが、実用確定性の核心です。[一次:S-CH08-001]

本章の締めは明確です。分岐が起きること自体より、分岐後の戻し方を統一できることが実務品質を決めます。[一次:S-CH08-001]

終端補足を統合します。第8章で外せない点は、分岐の有無ではなく、分岐後の戻し方を同じ語彙と同じ手順で説明できることです。再編成時に内部状態と外部案内が同期して更新される運用を維持できれば、収束規則は技術的正しさに加えて運用上の信頼を獲得できます。これが実用確定性の最終線です。[一次:S-CH08-001]

補足として、再編成時の説明語彙を固定することが利用者信頼の維持に直結します。[一次:S-CH08-001]

この手順統一が、分岐後収束の実務品質を決めます。[一次:S-CH08-001]

この確認は必須です。[一次:S-CH08-001]

可。[一次:S-CH08-001]

補足として、確率的確定性を運用する際は、閾値そのものより「閾値変更手順」を先に定義することが重要です。市場環境や業務要件が変わるたびに閾値を場当たりで変えると、利用者は確定概念を再学習できません。変更理由、適用時刻、旧閾値からの移行手順を定義しておけば、閾値更新が不信ではなく改善として受け取られます。第8章の収束規則は、固定値運用より更新可能な運用規律として理解するほうが実務に適合します。（要検証）
